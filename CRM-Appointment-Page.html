<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ - CRM</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #f0f8ff;
        }

        .bg-main {
            background-color: #e3f2fd;
        }

        .text-accent {
            color: #0288d1;
        }

        .btn-main {
            background-color: #81d4fa;
            color: white;
            font-weight: 500;
        }

        .btn-main:hover {
            background-color: #4fc3f7;
        }

        .btn-green {
            background-color: #a5d6a7;
        }

        .btn-green:hover {
            background-color: #81c784;
        }

        .rounded-xl {
            border-radius: 1rem;
        }

        .shadow-soft {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        }

        .loading-text {
            color: #0288d1;
            font-weight: 500;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.3;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.3;
            }
        }
    </style>
    <style>
        .modal-header {
            background-color: #e1f5fe;
            /* ‡∏ü‡πâ‡∏≤‡∏≠‡πà‡∏≠‡∏ô */
            color: #0277bd;
        }

        .hover\:bg-blue-50:hover {
            background-color: #e3f2fd;
        }

        .rounded-xl {
            border-radius: 1rem;
        }

        .shadow-lg {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
        }
    </style>

    <style>
        .fc .fc-toolbar-title {
            font-weight: 600;
            color: #4a90e2;
        }

        .fc-button {
            background-color: #a2d2ff !important;
            border: none;
            border-radius: 12px !important;
            font-weight: bold;
            color: #003f5c !important;
        }

        .fc-button:hover {
            background-color: #90cdf4 !important;
        }

        .fc-daygrid-day:hover {
            background-color: #e3f2fd;
        }

        #appointmentModal .bg-white {
            background: linear-gradient(to bottom right, #e0f7ff, #ffffff);
            border-radius: 20px;
        }

        .event-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-top: 2px;
        }

        .event-text {
            font-size: 0.85rem;
            font-weight: 500;
            color: #1e3a8a;
        }

        .fc-daygrid-day-frame {
            padding: 4px;
        }

        .bg-gray-50 {
            background-color: #eaf6ff !important;
        }

        .text-blue-600 {
            color: #0077b6 !important;
        }

        .bg-yellow-400 {
            background-color: #ffe066 !important;
            color: #333 !important;
        }

        .bg-green-600 {
            background-color: #48cae4 !important;
            color: white !important;
        }

        .bg-red-500 {
            background-color: #ff6b6b !important;
            color: white !important;
        }

        .rounded {
            border-radius: 12px !important;
        }

        .shadow {
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .fc-button {
            border: none !important;
            box-shadow: none !important;
        }

        /* ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å active ‡πÄ‡∏ä‡πà‡∏ô view: month / week / day */
        .fc .fc-button-active {
            background-color: #7ecbff !important;
            color: white !important;
            font-weight: bold;
            box-shadow: 0 0 0 2px #7ecbff66;
        }

        /* ‡∏õ‡∏∏‡πà‡∏° today ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡∏à‡∏∞ active */
        .fc .fc-today-button.fc-button-active {
            background-color: #7ecbff !important;
            color: white !important;
            box-shadow: 0 0 0 2px #7ecbff66;
        }

        .fc-day-today {
            background-color: #e3f2fd !important;
            /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ */
            border-radius: 8px;
        }

        .fc-daygrid-day.hovered {
            box-shadow: inset 0 0 0 3px #90caf9 !important;
            border-radius: 8px;
        }

        .fc-daygrid-day.fc-day-today.hovered {
            background-color: #e0f7fa !important;
            border-radius: 8px;
            box-shadow: inset 0 0 0 2px #00acc1;
        }
    </style>

    <style>
        .fc-daygrid-day:hover,
        .fc-daygrid-day.hovered {
            background-color: #f0f9ff;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .event-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin: 0 auto;
            margin-top: 2px;
        }

        #appointmentModal {
            z-index: 50;
        }

        .fc-event-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
        }

        .fc-daygrid-event {
            display: flex !important;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100% !important;
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            background: transparent !important;
            border: none !important;
            padding: 0 !important;
        }

        /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á dayGrid ‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô */
        .fc-daygrid-day-frame {
            max-height: 80px;
            /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ */
            overflow-y: hidden;
            /* ‡∏ï‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏≠‡∏≠‡∏Å */
            display: flex;
            flex-direction: column;
        }

        /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå (‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå) */
        .fc-daygrid-day-events {
            flex-grow: 1;
            overflow: hidden;
        }


        .event-text {
            font-size: 0.9rem;
            color: #000000;
            margin-top: 2px;

            /* ‚úÖ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ï‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô 1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;

            display: block;
            max-width: 100%;
            width: 100%;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen">
    <div class="flex">
        <!-- Sidebar -->
        <aside class="w-64 bg-blue-100 text-blue-900 min-h-screen shadow-md">
            <div class="px-6 py-4 text-xl font-bold border-b border-blue-200">üíº CRM System</div>
            <div class="px-6 text-sm mb-4">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
            <nav>
                <ul>
                    <li><a href="CRM-Dashboard-Layout.html" class="block px-6 py-3 hover:bg-blue-200">üìä Dashboard</a></li>
                    <li><a href="CRM-Customer-Page.html" class="block px-6 py-3 hover:bg-blue-200">üë• ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</a></li>
                    <li class="block px-6 py-3 bg-blue-200 rounded-l-full">üìÖ ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</li>
                    <li><a href="#" class="block px-6 py-3 hover:bg-blue-200">üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- Calendar Section -->
            <div class="lg:col-span-2 bg-white p-4 rounded shadow">
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-2xl font-bold text-accent">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</h1>
                    <button onclick="openNewAppointmentModal()" class="bg-green-600 text-white px-4 py-2 rounded">+
                        ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</button>
                </div>
                <div id="calendar"></div>
            </div>

            <!-- Appointment Detail Panel -->
            <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡∏ß‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
            <div class="w-full md:w-3/3 space-y-4">

                <!-- üîî ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á -->
                <div class="bg-white p-4 rounded shadow">
                    <h2 class="text-lg font-bold mb-4">üîî ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á (2 ‡∏ß‡∏±‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤)</h2>
                    <ul id="upcomingAppointmentsPanel" class="text-sm text-gray-700 space-y-2">
                        <li class="text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢...</li>
                    </ul>
                </div>

                <!-- üìÖ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ -->
                <div class="bg-white p-4 rounded shadow">
                    <h2 class="text-lg font-bold mb-4">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</h2>
                    <ul id="appointmentList" class="text-sm text-gray-700 space-y-2">
                        <li class="text-gray-400">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</li>
                    </ul>
                </div>
            </div>

        </main>
    </div>

    <!-- Appointment Modal -->
    <div id="appointmentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded w-full max-w-lg relative z-50">
            <div class="flex justify-between items-center mb-4">
                <h2 id="appointmentModalTitle" class="text-lg font-bold">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</h2>
                <button onclick="document.getElementById('appointmentModal').classList.add('hidden')">‚úï</button>
            </div>
            <form id="appointmentForm" class="space-y-3">
                <input type="date" name="date" class="w-full border px-3 py-2 rounded" required>
                <select name="customer" id="customerSelect" class="w-full border px-3 py-2 rounded" required>
                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</option>
                </select>
                <input type="text" name="purpose" class="w-full border px-3 py-2 rounded" placeholder="‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå">
                <input type="time" name="time" class="w-full border px-3 py-2 rounded">
                <textarea name="note" class="w-full border px-3 py-2 rounded h-20" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"></textarea>
                <select name="status" class="w-full border px-3 py-2 rounded">
                    <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                    <option value="‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß</option>
                </select>
                <button id="appointmentSubmitBtn" type="submit"
                    class="w-full bg-green-600 text-white py-2 rounded">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</button>
            </form>
        </div>
    </div>

    <script>
        function openNewAppointmentModal() {
            const form = document.getElementById('appointmentForm');

            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏õ‡πá‡∏ô "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢"
            document.getElementById('appointmentModalTitle').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢';
            document.getElementById('appointmentSubmitBtn').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢'; // Reset button text

            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°
            form.reset();

            // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ã‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            ['originalDate', 'originalCustomer', 'originalTime'].forEach(name => {
                const el = form.querySelector(`input[name="${name}"]`);
                if (el) el.remove();
            });

            // ‡∏•‡πâ‡∏≤‡∏á data-action (‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°)
            delete form.dataset.action;

            // ‡πÅ‡∏™‡∏î‡∏á Modal
            document.getElementById('appointmentModal').classList.remove('hidden');
        }

        const APPOINT_API = "https://script.google.com/macros/s/AKfycbwKgcJ5bwGXyqQ6mEBdd6w9f8DrAbZG_6tFRDAiTq402eERxml0ULfCl9umlqttsLoHvA/exec";
        const CUSTOMER_API = APPOINT_API + "?action=customers"; // ‡πÉ‡∏ä‡πâ API ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤

        function editAppointment(date, customer, purpose, time, note, status) {
            // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°
            document.getElementById('appointmentModalTitle').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢';
            document.getElementById('appointmentSubmitBtn').textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢';

            // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î Modal
            document.getElementById('appointmentModal').classList.remove('hidden');

            const form = document.getElementById('appointmentForm');

            // ‚úÖ ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
            form.date.value = date;
            form.customer.value = customer;
            form.purpose.value = purpose;

            let formattedTime = '';
            if (typeof time === 'string') {
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "18:00:00"
                if (/^\d{2}:\d{2}(:\d{2})?$/.test(time)) {
                    formattedTime = time.slice(0, 5); // ‡πÑ‡∏î‡πâ "18:00"
                } else {
                    const t = new Date(time);
                    if (!isNaN(t)) {
                        const hh = t.getHours().toString().padStart(2, '0');
                        const mm = t.getMinutes().toString().padStart(2, '0');
                        formattedTime = `${hh}:${mm}`;
                    }
                }
            }
            form.time.value = formattedTime;


            form.note.value = note;
            form.status.value = status;

            // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á hidden input ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
            ['originalDate', 'originalCustomer', 'originalTime'].forEach(name => {
                if (!form.querySelector(`input[name="${name}"]`)) {
                    const hidden = document.createElement('input');
                    hidden.type = 'hidden';
                    hidden.name = name;
                    form.appendChild(hidden);
                }
            });

            // ‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡πÉ‡∏ô hidden input
            form.querySelector('input[name="originalDate"]').value = date;
            form.querySelector('input[name="originalCustomer"]').value = customer;
            let originalTime = '';
            if (typeof time === 'string' && /^\d{2}:\d{2}/.test(time)) {
                originalTime = time; // ‡πÄ‡∏ä‡πà‡∏ô "13:00"
            } else {
                const t = new Date(time);
                if (!isNaN(t)) {
                    const hh = t.getHours().toString().padStart(2, '0');
                    const mm = t.getMinutes().toString().padStart(2, '0');
                    originalTime = `${hh}:${mm}`;
                }
            }
            form.querySelector('input[name="originalTime"]').value = originalTime;

            // ‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ form ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î update
            form.setAttribute('data-action', 'update');

        }

        let calendar;
        let allAppointments = [];
        let appointmentList;
        let upcomingAppointmentsPanel; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö panel ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á

        function deleteAppointment(date, customer, time) {
            // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà confirm() ‡∏î‡πâ‡∏ß‡∏¢ modal ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏á
            const confirmationModal = createConfirmationModal(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á ${customer} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`);
            document.body.appendChild(confirmationModal);

            confirmationModal.querySelector('#confirmDeleteBtn').onclick = () => {
                confirmationModal.remove(); // ‡∏õ‡∏¥‡∏î modal
                fetch(APPOINT_API, {
                    method: 'POST',
                    body: new URLSearchParams({
                        action: 'deleteAppointment',
                        date,
                        customer,
                        time
                    })
                })
                    .then(res => res.text())
                    .then(msg => {
                        alert("‡∏•‡∏ö‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");

                        // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏•‡∏ö
                        fetch(APPOINT_API + "?action=appointments")
                            .then(res => res.json())
                            .then(data => {
                                allAppointments = data;

                                // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
                                calendar.refetchEvents();

                                // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤‡πÉ‡∏´‡∏°‡πà
                                showAppointmentsForDate(date);
                                loadUpcomingAppointments(); // ‡πÇ‡∏´‡∏•‡∏î‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á‡πÉ‡∏´‡∏°‡πà
                            });
                    })
                    .catch(error => {
                        console.error("Error deleting appointment:", error);
                        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢");
                    });
            };

            confirmationModal.querySelector('#cancelDeleteBtn').onclick = () => {
                confirmationModal.remove(); // ‡∏õ‡∏¥‡∏î modal
            };
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Modal ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà confirm())
        function createConfirmationModal(message) {
            const modal = document.createElement('div');
            modal.id = 'confirmationModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full">
                    <p class="text-center text-lg mb-4">${message}</p>
                    <div class="flex justify-center space-x-4">
                        <button id="confirmDeleteBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                        <button id="cancelDeleteBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-md">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </div>
            `;
            return modal;
        }


        function showAppointmentsForDate(dateStr) {
            const filtered = allAppointments.filter(row => row[0] === dateStr);
            appointmentList.innerHTML = filtered.length > 0
                ? filtered.map(row => {
                    const rawTime = row[3];
                    let timeStr = '-';
                    if (rawTime) {
                        if (typeof rawTime === 'string' && /^\d{2}:\d{2}(:\d{2})?$/.test(rawTime)) {
                            timeStr = rawTime.slice(0, 5) + ' ‡∏ô.';
                        } else {
                            const d = new Date(rawTime);
                            if (!isNaN(d)) {
                                const h = d.getHours().toString().padStart(2, '0');
                                const m = d.getMinutes().toString().padStart(2, '0');
                                timeStr = `${h}:${m} ‡∏ô.`;
                            }
                        }
                    }

                    return `
                        <li class="border border-gray-200 p-2 rounded bg-gray-50 relative">
                            <strong class="text-blue-600">${row[1]}</strong>
                            <div class="text-sm text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${row[0]}</div>
                            <div class="text-sm text-gray-700">‡πÄ‡∏ß‡∏•‡∏≤: ${timeStr}</div>
                            <div class="text-sm text-gray-700">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå: ${row[2] || '-'}</div>
                            <div class="text-sm text-gray-500">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${row[4] || '-'}</div>
                            <div class="text-sm ${row[5] === '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß' ? 'text-green-600' : 'text-yellow-600'}">
                                ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${row[5] || '-'}
                            </div>

                            <!-- ‚úÖ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô -->
                            <div class="absolute bottom-2 right-2 flex gap-2">
                                <button onclick="editAppointment('${row[0]}', '${row[1]}', '${row[2]}', '${row[3]}', '${row[4]}', '${row[5]}')"
                                    class="text-xs bg-yellow-400 hover:bg-yellow-500 text-white px-2 py-1 rounded">
                                    ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                </button>
                                <button onclick="deleteAppointment('${row[0]}', '${row[1]}', '${row[3]}')"
                                    class="text-xs bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded">
                                    ‡∏•‡∏ö
                                </button>
                            </div>
                        </li>`;

                }).join('')
                : '<li class="text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</li>';
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á
        async function loadUpcomingAppointments() {
            upcomingAppointmentsPanel.innerHTML = '<li class="text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢...</li>';
            try {
                const res = await fetch(APPOINT_API + "?action=getUpcomingAppointments");
                const data = await res.json();

                if (data.length > 0) {
                    upcomingAppointmentsPanel.innerHTML = data.map(row => {
                        const rawTime = row[3];
                        let timeStr = '-';
                        if (rawTime) {
                            if (typeof rawTime === 'string' && /^\d{2}:\d{2}(:\d{2})?$/.test(rawTime)) {
                                timeStr = rawTime.slice(0, 5) + ' ‡∏ô.';
                            } else {
                                const d = new Date(rawTime);
                                if (!isNaN(d)) {
                                    const h = d.getHours().toString().padStart(2, '0');
                                    const m = d.getMinutes().toString().padStart(2, '0');
                                    timeStr = `${h}:${m} ‡∏ô.`;
                                }
                            }
                        }
                        return `
                            <li class="border border-blue-200 p-2 rounded bg-blue-50">
                                <strong class="text-blue-700">${row[1]}</strong>
                                <div class="text-sm text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${row[0]}</div>
                                <div class="text-sm text-gray-700">‡πÄ‡∏ß‡∏•‡∏≤: ${timeStr}</div>
                                <div class="text-sm text-gray-700">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå: ${row[2] || '-'}</div>
                                <div class="text-sm ${row[5] === '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß' ? 'text-green-600' : 'text-yellow-600'}">
                                    ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${row[5] || '-'}
                                </div>
                            </li>
                        `;
                    }).join('');
                } else {
                    upcomingAppointmentsPanel.innerHTML = '<li class="text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á‡πÉ‡∏ô 2 ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</li>';
                }
            } catch (err) {
                console.error("‡πÇ‡∏´‡∏•‡∏î‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", err);
                upcomingAppointmentsPanel.innerHTML = '<li class="text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á</li>';
            }
        }


        document.addEventListener('DOMContentLoaded', function () {
            const calendarEl = document.getElementById('calendar');
            const dateInput = document.querySelector('input[name="date"]');
            const customerSelect = document.getElementById('customerSelect');
            appointmentList = document.getElementById('appointmentList');
            upcomingAppointmentsPanel = document.getElementById('upcomingAppointmentsPanel'); // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£

            fetch(CUSTOMER_API)
                .then(res => res.json())
                .then(data => {
                    data.forEach(row => {
                        const name = row[1];
                        if (name) {
                            const option = document.createElement('option');
                            option.value = name;
                            option.textContent = name;
                            customerSelect.appendChild(option);
                        }
                    });
                });


            calendar = new FullCalendar.Calendar(calendarEl, {

                initialView: 'dayGridMonth',
                locale: 'th',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: fetchAppointments,
                eventDidMount: function (info) {
                    const row = allAppointments.find(r =>
                        r[0] === info.event.startStr.split('T')[0] &&
                        r[1] === info.event.title
                    );

                    let dotColor = 'gray';
                    if (row) {
                        if (row[5] === '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß') {
                            dotColor = 'green';
                        } else if (row[5] === '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') {
                            dotColor = 'orange';
                        }
                    }

                    info.el.innerHTML = `
            <div class="fc-event-center">
                <div class="event-indicator" style="background-color: ${dotColor}; width: 8px; height: 8px; border-radius: 50%; margin: 0 auto; margin-top: 2px;"></div>
                <div class="event-text">${info.event.title}</div>
            </div>
            `;
                },




                dateClick: function (info) {
                    const clickedDate = info.dateStr;
                    const calendarApi = calendar;

                    // üëâ ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    const clickedMonth = new Date(clickedDate).getMonth();
                    const currentMonth = calendarApi.getDate().getMonth();

                    if (clickedMonth !== currentMonth) {
                        calendarApi.gotoDate(clickedDate); // ‚úÖ ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÑ‡∏õ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà
                    }

                    // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ input ‡πÅ‡∏•‡∏∞‡πÑ‡∏Æ‡πÑ‡∏•‡∏ï‡πå
                    if (dateInput) {
                        dateInput.value = clickedDate;
                        dateInput.focus();
                    }

                    document.querySelectorAll(".fc-daygrid-day").forEach(cell => cell.classList.remove("hovered"));
                    info.dayEl.classList.add("hovered");
                    showAppointmentsForDate(clickedDate);

                    enableTodayButtonIfNeeded(); // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏° today ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô
                    toggleTodayButtonState(); // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏£ disable ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                },
                eventClick: function (info) {
                    const date = info.event.startStr.split('T')[0]; // ‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                    showAppointmentsForDate(date);
                    document.querySelectorAll(".fc-daygrid-day").forEach(cell => cell.classList.remove("hovered"));

                    // ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ï‡πå‡∏ä‡πà‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ú‡πà‡∏≤‡∏ô event
                    const dayCell = document.querySelector(`[data-date="${date}"]`);
                    if (dayCell) {
                        dayCell.classList.add("hovered");
                    }
                },
                eventContent: function (arg) {
                    return {
                        html: `
            <div class="fc-event-center">
                <div class="event-indicator"></div>
                <div class="event-text">${arg.event.title}</div>
            </div>
            `
                    };
                },

            });


            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏° Today ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
            function enableTodayButtonIfNeeded() {
                const todayStr = new Date().toISOString().split('T')[0];
                const hovered = document.querySelector('.fc-daygrid-day.hovered');
                const selectedDate = hovered?.dataset.date;

                if (selectedDate !== todayStr) {
                    const todayBtn = document.querySelector('.fc-today-button');
                    if (todayBtn?.disabled) {
                        todayBtn.disabled = false; // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏Å‡∏î
                        todayBtn.classList.remove('fc-button-disabled'); // ‚úÖ ‡∏•‡∏ö class ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏à‡∏≤‡∏á
                    }
                }
            }

            function toggleTodayButtonState() {
                const todayStr = new Date().toISOString().split('T')[0];
                const hovered = document.querySelector('.fc-daygrid-day.hovered');
                const selectedDate = hovered?.dataset.date;

                const todayBtn = document.querySelector('.fc-today-button');
                if (!todayBtn) return;

                if (selectedDate === todayStr) {
                    todayBtn.disabled = true;
                    todayBtn.classList.add('fc-button-disabled');
                } else {
                    todayBtn.disabled = false;
                    todayBtn.classList.remove('fc-button-disabled');
                }
            }


            calendar.render();
            const todayStr = new Date().toISOString().split('T')[0];
            const todayCell = document.querySelector(`.fc-daygrid-day[data-date="${todayStr}"]`);

            if (todayCell) {
                todayCell.classList.add("hovered");
                showAppointmentsForDate(todayStr);

                if (dateInput) {
                    dateInput.value = todayStr;
                    dateInput.focus();
                }

                toggleTodayButtonState(); // ‡πÄ‡∏û‡∏∑‡πà‡∏≠ disable ‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡πâ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            }

            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏î Today ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ + hover
            document.querySelector('.fc-today-button')?.addEventListener('click', () => {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                const calendarMonth = calendar.getDate().getMonth();
                const todayMonth = today.getMonth();

                console.log("üìå ‡∏õ‡∏∏‡πà‡∏° Today ‡∏ñ‡∏π‡∏Å‡∏Å‡∏î");
                console.log("üóìÔ∏è ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠:", todayStr);
                console.log("üìÜ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:", calendarMonth + 1); // +1 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
                console.log("üìÜ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:", todayMonth + 1);

                if (calendarMonth === todayMonth) {
                    // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    setTimeout(() => {
                        // ‡∏•‡∏ö hover ‡πÄ‡∏î‡∏¥‡∏°
                        document.querySelectorAll(".fc-daygrid-day").forEach(cell => cell.classList.remove("hovered"));

                        // ‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° hover ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                        const todayCell = document.querySelector(`.fc-daygrid-day[data-date="${todayStr}"]`);
                        if (todayCell) {
                            todayCell.classList.add("hovered"); // ‡πÄ‡∏û‡∏¥‡πà‡∏° hover ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                            todayCell.scrollIntoView({ behavior: "smooth", block: "center" });
                        }

                        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                        showAppointmentsForDate(todayStr);

                        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° input (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                        const dateInput = document.querySelector('input[name="date"]');
                        if (dateInput) {
                            dateInput.value = todayStr;
                            dateInput.focus();
                        }

                        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏° Today
                        toggleTodayButtonState();
                    }, 100);
                } else {
                    // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                    calendar.gotoDate(today); // ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                    setTimeout(() => {
                        document.querySelectorAll(".fc-daygrid-day").forEach(cell => cell.classList.remove("hovered"));

                        const todayCell = document.querySelector(`.fc-daygrid-day[data-date="${todayStr}"]`);
                        if (todayCell) {
                            todayCell.classList.add("hovered"); // ‡πÄ‡∏û‡∏¥‡πà‡∏° hover ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                            todayCell.scrollIntoView({ behavior: "smooth", block: "center" });
                        }

                        showAppointmentsForDate(todayStr);
                        toggleTodayButtonState(); // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏° Today
                    }, 200); // ‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡∏•‡∏≤ FullCalendar ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô
                }
            });


            toggleTodayButtonState();

            showAppointmentsForDate(new Date().toISOString().split('T')[0]);
            loadUpcomingAppointments(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö

            document.getElementById('appointmentForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);

                const action = form.getAttribute('data-action') === 'update' ? 'updateAppointment' : 'addAppointment';


                formData.append('action', action);
                console.log([...formData]); // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ originalDate, originalCustomer, originalTime ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                for (let [key, val] of formData.entries()) {
                    console.log(`${key}: ${val}`);
                }
                fetch(APPOINT_API, {
                    method: 'POST',
                    body: formData
                })
                    .then(res => res.text())
                    .then(msg => {
                        console.log("üü¢ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", msg);

                        alert(action === 'updateAppointment' ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');

                        const updatedDate = form.date.value;

                        console.log("üìÜ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï:", updatedDate);
                        console.log("‚è≥ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å Sheet...");

                        // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
                        fetch(APPOINT_API + "?action=appointments")
                            .then(res => res.json())
                            .then(data => {
                                console.log("‚úÖ ‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• appointments ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß:", data);

                                allAppointments = data;

                                // 2. ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô (dot ‡∏™‡∏µ‡∏à‡∏∞‡∏≠‡∏¥‡∏á allAppointments)
                                console.log("üîÑ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å calendar.refetchEvents()...");
                                calendar.refetchEvents();

                                // 3. ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô render ‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÅ‡∏™‡∏î‡∏á‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤
                                setTimeout(() => {
                                    console.log("üìã ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å showAppointmentsForDate():", updatedDate);
                                    showAppointmentsForDate(updatedDate);
                                    loadUpcomingAppointments(); // ‡πÇ‡∏´‡∏•‡∏î‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á‡πÉ‡∏´‡∏°‡πà

                                    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô class hovered ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà
                                    document.querySelectorAll(".fc-daygrid-day").forEach(cell => cell.classList.remove("hovered"));
                                    const newDayCell = document.querySelector(`[data-date="${updatedDate}"]`);
                                    if (newDayCell) {
                                        newDayCell.classList.add("hovered");
                                    }

                                }, 500);
                            });

                        // 4. ‡∏õ‡∏¥‡∏î modal ‡πÅ‡∏•‡∏∞ reset form
                        document.getElementById('appointmentModal').classList.add('hidden');
                        form.reset();
                        form.removeAttribute('data-action');
                    })
                    .catch(error => {
                        console.error("Error submitting appointment:", error);
                        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢");
                    });
            });

            function fetchAppointments(fetchInfo, successCallback, failureCallback) {
                fetch(APPOINT_API + "?action=appointments")
                    .then(res => res.json())
                    .then(data => {
                        allAppointments = data;

                        const events = data.map(row => {
                            const date = row[0];    // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                            const name = row[1];    // ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                            const purpose = row[2]; // ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå
                            const rawTime = row[3]; // ‡πÄ‡∏ß‡∏•‡∏≤
                            const note = row[4];    // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏
                            const status = row[5];  // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞

                            let timeStr = "";
                            let start = date;
                            let allDay = true;

                            // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô HH:mm
                            if (rawTime) {
                                if (typeof rawTime === "string" && /^\d{2}:\d{2}/.test(rawTime)) {
                                    timeStr = rawTime;
                                } else {
                                    const t = new Date(rawTime);
                                    if (!isNaN(t)) {
                                        const h = t.getHours().toString().padStart(2, '0');
                                        const m = t.getMinutes().toString().padStart(2, '0');
                                        timeStr = `${h}:${m}`;
                                    }
                                }

                                if (timeStr) {
                                    start = `${date}T${timeStr}:00`;
                                    allDay = false;
                                }
                            }

                            return {
                                title: name || '‡∏ô‡∏±‡∏î',
                                start,
                                allDay
                            };
                        });

                        successCallback(events);

                        // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                        const todayStr = new Date().toISOString().split('T')[0];
                        const todayCell = document.querySelector(`.fc-daygrid-day[data-date="${todayStr}"]`);
                        if (todayCell) {
                            todayCell.classList.add("hovered");
                        }
                        showAppointmentsForDate(todayStr);

                        if (dateInput) {
                            dateInput.value = todayStr;
                            dateInput.focus();
                        }

                        toggleTodayButtonState(); // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏° Today (‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏´‡πâ disable)
                        todayCell?.scrollIntoView({ behavior: "smooth", block: "center" });


                    })
                    .catch(failureCallback);
            }



        });
    </script>
</body>

</html>